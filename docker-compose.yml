version: '"'"'3.8'"'"'

services:
  nginx:
    image: nginx:alpine
    container_name: lab6-nginx
    ports:
      - '"'"'8080:80'"'"'
    volumes:
      - ./www:/var/www/html
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - php
      - redis
      - elasticsearch
      - clickhouse
    networks:
      - lab-network

  php:
    build: .
    container_name: lab6-php
    volumes:
      - ./www:/var/www/html
    working_dir: /var/www/html
    depends_on:
      - redis
      - elasticsearch
      - clickhouse
    networks:
      - lab-network

  db:
    image: mysql:8.0
    container_name: lab6-db
    environment:
      MYSQL_ROOT_PASSWORD: rootpassword
      MYSQL_DATABASE: hackathon_db
      MYSQL_USER: hackathon_user
      MYSQL_PASSWORD: hackathon_pass
    ports:
      - '"'"'3307:3306'"'"'
    volumes:
      - db_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - lab-network

  redis:
    image: redis:7-alpine
    container_name: lab6-redis
    ports:
      - '"'"'6379:6379'"'"'
    volumes:
      - redis_data:/data
    networks:
      - lab-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.10.2
    container_name: lab6-elasticsearch
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    ports:
      - '"'"'9200:9200'"'"'
    volumes:
      - elastic_data:/usr/share/elasticsearch/data
    networks:
      - lab-network

  clickhouse:
    image: clickhouse/clickhouse-server:24
    container_name: lab6-clickhouse
    ports:
      - '"'"'8123:8123'"'"'
      - '"'"'9000:9000'"'"'
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - lab-network

  adminer:
    image: adminer
    container_name: lab6-adminer
    restart: always
    ports:
      - '"'"'8081:8080'"'"'
    depends_on:
      - db
    networks:
      - lab-network

networks:
  lab-network:
    driver: bridge

volumes:
  db_data:
  redis_data:
  elastic_data:
  clickhouse_data:
